<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kalola Family Tree</title>
  <style>
    /* Full-screen canvas */
    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f9f9f9;
    }

    #chart-container {
      width: 100%;
      height: 100%;
      cursor: move;
      /* Grab cursor for panning */
    }

    /* Style for the nodes */
    .node circle {
      stroke: steelblue;
      stroke-width: 3px;
      cursor: pointer;
      fill: #fff;
      transition: fill 0.3s, stroke 0.3s;
    }

    /* Nodes with children (internal) */
    .node--internal circle {
      fill: steelblue;
      /* Blue fill for parents */
    }

    .node--internal circle:hover {
      stroke: #2a6592;
      fill: #2a6592;
    }

    .node--leaf circle:hover {
      fill: #f0f0f0;
    }

    /* Text styles */
    .node text {
      font-size: 14px;
      font-weight: bold;
      fill: #333;
      /* Positioned via D3 */
    }

    .node .spouse {
      font-size: 11px;
      font-style: italic;
      fill: #666;
    }

    .node .name {
      cursor: pointer;
      fill: #0056b3;
    }

    .node .name:hover {
      text-decoration: underline;
    }

    /* --- ADDED: Styles for 'daughter' nodes --- */
    .node--daughter circle {
      fill: pink;
      stroke: #d81b60;
      /* Darker pink for stroke */
    }

    /* Internal daughter nodes are also pink, overriding steelblue */
    .node--daughter.node--internal circle {
      fill: pink;
    }

    .node--daughter circle:hover {
      fill: #f06292;
      /* Lighter pink on hover */
      stroke: #d81b60;
    }

    /* ADDED: Make daughter's name pink */
    .node--daughter .name {
      fill: #d81b60;
      /* Dark pink, same as stroke */
    }

    /* --- End Added Styles --- */

    /* Link styles (curved) */
    .link {
      fill: none;
      stroke: #ccc;
      stroke-width: 2px;
    }
  </style>
</head>

<body>

  <div>
    <button id="btn-language">
      Gujarati
    </button>
  </div>
  <div id="chart-container"></div>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <script>
    const treeData = {"name":"Gova","spouse":"","children":[{"name":"Akhi","spouse":"","children":[{"name":"Arajan","spouse":"","children":[{"name":"Hari","spouse":"","children":[{"name":"Keshav","spouse":"","children":[{"name":"Narshih","spouse":"Santok","children":[{"name":"Javi","daughter":true,"spouse":"Thobhan","children":[]},{"name":"Devraj","spouse":"Savita","children":[{"name":"Harsukh","spouse":"Dhiri","children":[{"name":"Manish","spouse":"Nehal","children":[{"name":"Zeel","daughter":true,"spouse":"","children":[]},{"name":"Hetvik","spouse":"","children":[]}]},{"name":"Raj","spouse":"Geeta","children":[{"name":"Nirva","daughter":true,"spouse":"","children":[]},{"name":"Reva","daughter":true,"spouse":"","children":[]},{"name":"Man","spouse":"","children":[]}]},{"name":"Atul","spouse":"","children":[]}]},{"name":"Kanti","spouse":"Jaya","children":[{"name":"Riddhi","daughter":true,"spouse":"Pankaj","children":[]},{"name":"Kirti","daughter":true,"spouse":"Rakesh","children":[]},{"name":"Vivek","spouse":"Pooja","children":[]}]},{"name":"Chandu","spouse":"Hansa","children":[{"name":"Ashish","spouse":"","children":[]}]},{"name":"Dhansukh","spouse":"Geeta","children":[{"name":"Ruchi","daughter":true,"spouse":"","children":[]},{"name":"Yash","spouse":"","children":[]}]}]},{"name":"Magi","daughter":true,"spouse":"Kanji","children":[]},{"name":"Hemi","daughter":true,"spouse":"Amba","children":[]},{"name":"Ramji","spouse":"Mukta","children":[{"name":"Hansa","daughter":true,"spouse":"Praful","children":[]},{"name":"Neeta","daughter":true,"spouse":"Ramesh","children":[]},{"name":"Ratilal","spouse":"Sita","children":[]},{"name":"Bharat","spouse":"","children":[]}]},{"name":"Zamku","daughter":true,"spouse":"Magan","children":[]},{"name":"Chhagan","spouse":"Jaya","children":[{"name":"Bhanu","daughter":true,"spouse":"Ashwin","children":[]},{"name":"Rashik","spouse":"Revanta","children":[{"name":"Harvi","daughter":true,"spouse":"","children":[]},{"name":"Neel","spouse":"","children":[]}]},{"name":"Manoj","spouse":"Geeta","children":[{"name":"Yarvi","daughter":true,"spouse":"","children":[]}]},{"name":"Praful","spouse":"Chetna","children":[]}]},{"name":"Labhu","daughter":true,"spouse":"Shamji","children":[]},{"name":"Indu","daughter":true,"spouse":"Damji","children":[]}]},{"name":"Jina","spouse":"","children":[]},{"name":"Kashtur","daughter":true,"spouse":"Mohan","children":[]}]},{"name":"Premji","spouse":"Ladhi","children":[{"name":"Naran","spouse":"Mani","children":[{"name":"Vallabh","spouse":"","children":[{"name":"Lalit","spouse":"Dharmishta","children":[{"name":"Gargi","daughter":true,"spouse":"","children":[]},{"name":"Tanuj","spouse":"","children":[]}]}]},{"name":"Amrutlal","spouse":"Manujla","children":[{"name":"Rima","daughter":true,"spouse":"Pritesh","children":[]}]},{"name":"Manu","spouse":"Bhanu","children":[{"name":"Nayna","daughter":true,"spouse":"Vijay","children":[]},{"name":"Jignesh","spouse":"Radhika","children":[{"name":"Yug","spouse":"","children":[]}]},{"name":"Kishan","spouse":"Alka","children":[{"name":"Taksh","spouse":"","children":[]}]}]},{"name":"Kana","spouse":"Hansa","children":[{"name":"Chandani","daughter":true,"spouse":"Rohit","children":[]},{"name":"Diya","daughter":true,"spouse":"","children":[]}]},{"name":"Balu","spouse":"Manjula","children":[{"name":"Anita","daughter":true,"spouse":"Vikas","children":[]},{"name":"Kelvin","spouse":"Khushbu","children":[{"name":"Kanishk","spouse":"","children":[]}]}]},{"name":"Sharda","daughter":true,"spouse":"Parshotam","children":[]}]},{"name":"???","daughter":true,"spouse":"","children":[]}]},{"name":"Devshi","spouse":"","children":[{"name":"Lalji","spouse":"Sati","children":[{"name":"Arjan","spouse":"Champa","children":[{"name":"Ramesh","spouse":"Nayna","children":[{"name":"Nirav","spouse":"Mansi","children":[]},{"name":"Denish","spouse":"","children":[]}]},{"name":"Bipin","spouse":"Shilpa","children":[{"name":"Drashti","daughter":true,"spouse":"","children":[]},{"name":"Krisha","daughter":true,"spouse":"","children":[]}]}]},{"name":"Parshotam","spouse":"Rambha","children":[{"name":"Vijay","spouse":"Pragna","children":[{"name":"Ayushi","daughter":true,"spouse":"","children":[]}]},{"name":"Lalit","spouse":"","children":[]},{"name":"Ketan","spouse":"","children":[]}]},{"name":"Tulshi","spouse":"Rasila","children":[{"name":"Savan","spouse":"Svati","children":[{"name":"Shivansh","spouse":"","children":[]}]},{"name":"Ankit","spouse":"Payal","children":[{"name":"Devanshi","spouse":"","children":[]}]}]},{"name":"Savita","daughter":true,"spouse":"Kara","children":[]},{"name":"Manju","daughter":true,"spouse":"Vallabh","children":[]},{"name":"Lili","daughter":true,"spouse":"Narotam","children":[]}]},{"name":"Natha","spouse":"Rambha","children":[{"name":"Jaman","spouse":"Rasila","children":[{"name":"Rajesh","spouse":"","children":[]},{"name":"Babu","spouse":"","children":[]}]},{"name":"Ramnik","spouse":"Jyotsna","children":[{"name":"Sagar","spouse":"","children":[]},{"name":"Bhautik","spouse":"","children":[]},{"name":"???","spouse":"","children":[]}]},{"name":"Dhiru","spouse":"Saroj","children":[{"name":"Pradip","spouse":"","children":[]},{"name":"Dhruvi","spouse":"","children":[]}]},{"name":"Hasu","spouse":"Daksha","children":[{"name":"Nimanshu","daughter":true,"spouse":"","children":[]},{"name":"Yatin","spouse":"","children":[]}]},{"name":"Jaya","daughter":true,"spouse":"Jaman","children":[]}]}]},{"name":"Thobhan","spouse":"","children":[{"name":"Lakhman","spouse":"Vagti","children":[{"name":"Mohan","spouse":"Jamna","children":[{"name":"Champa","daughter":true,"spouse":"","children":[]},{"name":"Kanchan","daughter":true,"spouse":"","children":[]},{"name":"Bhanu","daughter":true,"spouse":"","children":[]},{"name":"Hansa","daughter":true,"spouse":"","children":[]}]},{"name":"Khima","spouse":"Jamku","children":[{"name":"Suresh","spouse":"","children":[]},{"name":"Chandu","spouse":"","children":[]},{"name":"???","spouse":"","children":[]},{"name":"???","daughter":true,"spouse":"","children":[]}]}]}]}]}]}]}]};
    const translator = {"Gova":"ગોવા","Akhi":"અખી","Arajan":"અરાજન","Hari":"હરિ","Keshav":"કેશવ","Narshih":"નરસિંહ","Santok":"સંતોક","Javi":"જવી","Thobhan":"થોભણ","Devraj":"દેવરાજ","Savita":"સવિતા","Harsukh":"હરસુખ","Dhiri":"ધીરી","Manish":"મનીષ","Nehal":"નેહલ","Zeel":"ઝીલ","Hetvik":"હેત્વિક","Raj":"રાજ","Geeta":"ગીતા","Nirva":"નિર્વા","Reva":"રેવા","Man":"માન","Atul":"અતુલ","Kanti":"કાંતિ","Jaya":"જયા","Riddhi":"રિદ્ધિ","Pankaj":"પંકજ","Kirti":"કીર્તિ","Rakesh":"રાકેશ","Vivek":"વિવેક","Pooja":"પૂજા","Chandu":"ચંદુ","Hansa":"હંસા","Ashish":"આશિષ","Dhansukh":"ધનસુખ","Ruchi":"રુચિ","Yash":"યશ","Magi":"મગી","Kanji":"કાનજી","Hemi":"હેમી","Amba":"અંબા","Ramji":"રામજી","Mukta":"મુક્તા","Neeta":"નીતા","Ramesh":"રમેશ","Ratilal":"રતિલાલ","Sita":"સીતા","Bharat":"ભરત","Zamku":"ઝમકુ","Magan":"મગન","Chhagan":"છગન","Bhanu":"ભાનુ","Ashwin":"અશ્વિન","Rashik":"રસિક","Revanta":"રેવન્તા","Harvi":"હાર્વી","Neel":"નીલ","Manoj":"મનોજ","Yarvi":"યાર્વી","Praful":"પ્રફુલ","Chetna":"ચેતના","Labhu":"લાભુ","Shamji":"શામજી","Indu":"ઇન્દુ","Damji":"દામજી","Jina":"જીના","Kashtur":"કસ્તુર","Mohan":"મોહન","Premji":"પ્રેમજી","Ladhi":"લધી","Naran":"નારણ","Mani":"મણિ","Vallabh":"વલ્લભ","Lalit":"લલિત","Dharmishta":"ધર્મિષ્ઠા","Gargi":"ગાર્ગી","Tanuj":"તનુજ","Amrutlal":"અમૃતલાલ","Manujla":"મંજુલા","Rima":"રીમા","Pritesh":"પ્રિતેશ","Manu":"મનુ","Nayna":"નયના","Vijay":"વિજય","Jignesh":"જીગ્નેશ","Radhika":"રાધિકા","Yug":"યુગ","Kishan":"કિશન","Alka":"અલ્કા","Taksh":"તક્ષ","Kana":"કાના","Chandani":"ચાંદની","Rohit":"રોહિત","Diya":"દિયા","Balu":"બાલુ","Manjula":"મંજુલા","Anita":"અનિતા","Vikas":"વિકાસ","Kelvin":"કેલ્વિન","Khushbu":"ખુશ્બુ","Kanishk":"કનિષ્ક","Sharda":"શારદા","Parshotam":"પરષોત્તમ","Devshi":"દેવશી","Lalji":"લાલજી","Sati":"સતી","Arjan":"અરજણ","Champa":"ચંપા","Nirav":"નીરવ","Mansi":"માનસી","Denish":"દેનીશ","Bipin":"બિપિન","Shilpa":"શિલ્પા","Drashti":"દ્રષ્ટિ","Krisha":"ક્રિશા","Rambha":"રંભા","Pragna":"પ્રજ્ઞા","Ayushi":"આયુષી","Ketan":"કેતન","Tulshi":"તુલસી","Rasila":"રસીલા","Savan":"સાવન","Svati":"સ્વાતિ","Shivansh":"શિવાંશ","Ankit":"અંકિત","Payal":"પાયલ","Devanshi":"દેવાંશી","Kara":"કારા","Manju":"મંજુ","Lili":"લીલી","Narotam":"નરોત્તમ","Natha":"નથ્થા","Jaman":"જમન","Rajesh":"રાજેશ","Babu":"બાબુ","Ramnik":"રમણીક","Jyotsna":"જ્યોત્સના","Sagar":"સાગર","Bhautik":"ભૌતિક","Dhiru":"ધીરુ","Saroj":"સરોજ","Pradip":"પ્રદીપ","Dhruvi":"ધ્રુવી","Hasu":"હસુ","Daksha":"દક્ષા","Nimanshu":"નિમાન્શુ","Yatin":"યતિન","Lakhman":"લખમણ","Vagti":"વગતી","Jamna":"જમના","Kanchan":"કંચન","Khima":"ખીમા","Jamku":"જમકુ","Suresh":"સુરેશ","???":"???"};
    var isGujarati = false;
  </script>

  <script>
    // --- 2. CHART SETTINGS ---
    // Use dynamic window dimensions
    let width = window.innerWidth;
    let height = window.innerHeight;

    const margin = ({ top: 80, right: 120, bottom: 80, left: 120 });

    // --- OPTIMIZATION: Increased horizontal spacing ---
    // Increased from 100 to 150 to prevent text overlap
    const dx = 150;
    // Vertical spacing between generations
    const dy = 180;
    const duration = 200; // Animation duration

    const tree = d3.tree().nodeSize([dx, dy]);

    // --- 3. PREPARE THE DATA ---
    const root = d3.hierarchy(treeData);
    root.x0 = 0;
    root.y0 = 0;

    root.descendants().forEach((d, i) => {
      d.id = i; // Use index as the unique D3 ID
      d.data.id = i; // Generate dynamic IDs [make sure this is in sync with _data/people.js]
      d._children = d.children;
      if (d.depth > 3) d.children = null;
    });

    // --- 4. CREATE THE SVG CONTAINER ---
    const svg = d3.create("svg")
      .attr("width", width)
      .attr("height", height)
      .attr("viewBox", [0, 0, width, height])
      .style("background-color", "#f9f9f9");

    // Main group for panning and zooming
    const g = svg.append("g");

    const gLink = g.append("g")
      .attr("fill", "none")
      .attr("stroke", "#ccc")
      .attr("stroke-width", 2);

    const gNode = g.append("g")
      .attr("pointer-events", "all");

    // --- 5. DEFINE ZOOM & CENTERING ---
    const zoom = d3.zoom()
      .scaleExtent([0.1, 3])
      .on("zoom", (event) => {
        g.attr("transform", event.transform);
      });

    // IMPROVEMENT: Updated to use dynamic window dimensions
    function centerNode(node) {
      const k = d3.zoomTransform(svg.node()).k; // Get current scale
      const w = window.innerWidth;
      const h = window.innerHeight;

      svg.transition().duration(600)
        .call(zoom.transform, d3.zoomIdentity
          .translate(w / 2, h / 2) // Move origin to center
          .scale(k) // Apply current scale
          .translate(-node.x, -node.y) // Move node's (x,y) to origin
        );
    }

    // IMPROVEMENT: Custom curved link generator
    function curvedLink(d) {
      // Creates a vertical quadratic Bézier curve.
      const sourceX = d.source.x;
      const sourceY = d.source.y;
      const targetX = d.target.x;
      const targetY = d.target.y;

      // Midpoint for control
      const midY = (sourceY + targetY) / 2;

      return `M${sourceX},${sourceY} C${sourceX},${midY} ${targetX},${midY} ${targetX},${targetY}`;
    }

    // --- 6. THE MAIN UPDATE FUNCTION ---
    function update(source) {
      const nodes = root.descendants().reverse();
      const links = root.links();

      // Compute the new layout.
      tree(root);

      // --- Update the Nodes ---
      const node = gNode.selectAll("g.node")
        .data(nodes, d => d.id); // Join based on the index ID

      const nodeEnter = node.enter().append("g")
        // MODIFIED: Add 'node--daughter' class if data is true
        .attr("class", d => `node ${d._children ? "node--internal" : "node--leaf"} ${d.data.daughter ? "node--daughter" : ""}`)
        .attr("transform", d => `translate(${source.x0},${source.y0})`)
        .attr("fill-opacity", 0)
        .attr("stroke-opacity", 0);

      // CLICK THE CIRCLE TO COLLAPSE AND CENTER
      nodeEnter.append("circle")
        .attr("r", 8)
        .on("click", (event, d) => {
          d.children = d.children ? null : d._children;
          update(d); // Re-run the update

          // Center on the clicked node after transition
          setTimeout(() => {
            centerNode(d);
          }, duration + 50);
        });

      // --- OPTIMIZATION: Fixed comment typo ---
      // ADD TEXT (NAME + SPOUSE)
      const text = nodeEnter.append("text")
        .attr("text-anchor", "middle")
        // Position the whole text block 30px ABOVE the circle
        .attr("y", -30);

      // CLICK THE NAME TO NAVIGATE
      text.append("tspan")
        .attr("class", "name")
        .attr("x", 0) // Ensure it's centered
        .text((d) => {
          if (isGujarati) {
            return translator[d.data.name];
          }
          return d.data.name;
        })
        .on("click", (event, d) => {
          event.stopPropagation(); // Don't trigger the circle click
          window.location.href = `people/${d.data.id}/`;
        });

      // ADD SPOUSE
      text.append("tspan")
        .attr("class", "spouse")
        .attr("x", 0) // Ensure it's centered
        .attr("dy", "1.2em") // 1.2em *below* the name
        .text((d) => {
          if (d.data.spouse) {
            if (isGujarati) {
              return translator[d.data.spouse];
            }
            return d.data.spouse;
          }
          return "";
        });

      // Transition nodes to their new position.
      // Get the merged selection (don't chain .transition() yet)
      const nodeUpdate = node.merge(nodeEnter);

      // Apply the transition
      nodeUpdate.transition().duration(duration)
        .attr("transform", d => `translate(${d.x},${d.y})`)
        .attr("fill-opacity", 1)
        .attr("stroke-opacity", 1);

      // NOW, update text on ALL nodes (entering and existing)
      nodeUpdate.select("tspan.name")
        .text((d) => {
          if (isGujarati) {
            return translator[d.data.name];
          }
          return d.data.name;
        });

      nodeUpdate.select("tspan.spouse")
        .text((d) => {
          if (d.data.spouse) {
            if (isGujarati) {
              return translator[d.data.spouse];
            }
            return d.data.spouse;
          }
          return "";
        });

      // ADDED: Update class attributes on all nodes (for expand/collapse)
      node.merge(nodeEnter)
        .attr("class", d => `node ${d._children ? "node--internal" : "node--leaf"} ${d.data.daughter ? "node--daughter" : ""}`);

      // Correctly update circle fill (CSS will override this for daughters)
      nodeUpdate.select("circle")
        .attr("fill", d => d._children ? "steelblue" : "#fff");

      // Transition exiting nodes to the parent's new position.
      node.exit().transition().duration(duration).remove()
        .attr("transform", d => `translate(${source.x},${source.y})`)
        .attr("fill-opacity", 0)
        .attr("stroke-opacity", 0);

      // --- Update the Links (Now Curved) ---
      const link = gLink.selectAll("path")
        .data(links, d => d.target.id);

      // Enter new links at the parent's previous position.
      const linkEnter = link.enter().append("path")
        .attr("class", "link")
        .attr("d", d => {
          const o = { x: source.x0, y: source.y0 };
          // Draw a flat line from the source
          return `M${o.x},${o.y} C${o.x},${o.y} ${o.x},${o.y} ${o.x},${o.y}`;
        });

      // Transition links to their new position.
      link.merge(linkEnter).transition().duration(duration)
        .attr("d", curvedLink); // Use the new curved link generator

      // Transition exiting links to the parent's new position.
      link.exit().transition().duration(duration).remove()
        .attr("d", d => {
          const o = { x: source.x, y: source.y };
          // Collapse the link back into the source
          return `M${o.x},${o.y} C${o.x},${o.y} ${o.x},${o.y} ${o.x},${o.y}`;
        });

      // Stash the old positions for transition.
      root.eachBefore(d => {
        d.x0 = d.x;
        d.y0 = d.y;
      });
    }

    // --- 7. RESIZE HANDLER ---
    // IMPROVEMENT: Make the chart responsive
    function handleResize() {
      width = window.innerWidth;
      height = window.innerHeight;

      svg.attr("width", width)
        .attr("height", height)
        .attr("viewBox", [0, 0, width, height]);

      // Re-center the view on the root node
      const k = d3.zoomTransform(svg.node()).k;

      svg.transition().duration(250)
        .call(zoom.transform, d3.zoomIdentity
          .translate(width / 2, margin.top) // Move origin to top-center
          .scale(k)
          .translate(-root.x, -root.y) // Center the root node
        );
    }

    window.addEventListener('resize', handleResize);

    // --- 8. INITIALIZE ZOOM & RENDER ---

    // Call zoom to attach it to the SVG
    svg.call(zoom);

    // --- Initial Render ---
    update(root); // This synchronously computes root.x and root.y

    // --- BUG FIX: Center on the Root Node on Load ---
    // The original code didn't account for the root's calculated x/y position.
    setTimeout(() => {
      const k = 1.0; // Initial scale

      svg.transition().duration(750)
        .call(zoom.transform, d3.zoomIdentity
          .translate(width / 2, margin.top) // Move viewport origin to top-center
          .scale(k)
          .translate(-root.x, -root.y) // Pan to align the root node with the origin
        );
    }, 100); // Small delay to ensure everything is rendered

    // --- Add the SVG to the page ---
    document.getElementById("chart-container").append(svg.node());
    document.getElementById("btn-language").onclick = function () { 
      isGujarati = !isGujarati; 
      document.getElementById("btn-language").innerHTML = isGujarati ? "English" : "Gujarati";
      update(root); 
    };
  </script>

</body>

</html>